<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Étape 8 — Réinitialisation mot de passe</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header>
    <h1>Étape 8 — Réinitialisation mot de passe</h1>
    <p>Permettre à l’utilisateur de récupérer son mot de passe en toute sécurité</p>
  <nav class="navbar">
  <a href="01-initialisation.html">Étape 1 — Initialisation du projet</a>
        <a href="02-twig.html">Étape 2 — Twig et premier rendu</a>
        <a href="03-mysql.html">Étape 3 — Connexion MySQL</a>
        <a href="04-mvc.html">Étape 4 — Structure MVC</a>
        <a href="05-auth-inscription.html">Étape 5 — Authentification (Inscription)</a>
        <a href="06-auth-connexion.html">Étape 6 — Authentification (Connexion)</a>
        <a href="07-verification-email.html">Étape 7 — Vérification d’email</a>
        <a href="08-reset-password.html">Étape 8 — Réinitialisation mot de passe</a>
        <a href="09-roles.html">Étape 9 — Gestion des rôles</a>
        <a href="10-crud-categories.html">Étape 10 — CRUD Catégories</a>
        <a href="11-crud-annonces.html">Étape 11 — CRUD Annonces + Upload images</a>
        <a href="12-securite-tests-deploiement.html">Étape 12 — Sécurité, tests et déploiement</a>
  </nav>  
</header>

  <main>
    <section class="objectifs">
      <h2>Objectifs</h2>
      <ul>
        <li>Comprendre l’intérêt de la réinitialisation sécurisée</li>
        <li>Envoyer un lien unique par email</li>
        <li>Mettre à jour le mot de passe dans MySQL avec hashing</li>
        <li>Protéger le processus pour éviter les abus</li>
      </ul>
    </section>

    <section class="explanation">
      <h2>Pourquoi sécuriser la réinitialisation ?</h2>
      <p>
        Les mots de passe ne doivent jamais être envoyés en clair. Le processus de réinitialisation doit être sécurisé :
      </p>
      <ul>
        <li>Le lien doit être unique et expirer après un certain temps</li>
        <li>Le nouveau mot de passe est toujours haché avant stockage</li>
        <li>Seul l’utilisateur propriétaire du mail peut changer le mot de passe</li>
      </ul>
    </section>

    <section class="commands">
      <h2>Dépendances</h2>
      <pre><code>
npm install nodemailer crypto bcrypt
      </code></pre>

      <h2>Structure MVC</h2>
      <pre><code>
/src
  /controllers
    authController.js
  /models
    userModel.js
  /routes
    authRoutes.js
  /config
    mail.js
  /views
    reset-request.twig
    reset-password.twig
.env
      </code></pre>
    </section>

    <section class="example">
      <h2>Exemple complet</h2>

      <p>1. Génération du token et envoi email (dans <code>authController.js</code>)</p>
      <pre><code>
import { transporter } from "../config/mail.js";
import crypto from "crypto";
import { setResetToken, getUserByEmail } from "../models/userModel.js";

export async function requestReset(req, res) {
  const { email } = req.body;
  const user = await getUserByEmail(email);
  if (!user) return res.render("reset-request", { error: "Email non trouvé" });

  const token = crypto.randomBytes(32).toString("hex");
  const expires = Date.now() + 3600000; // 1 heure
  await setResetToken(user.id, token, expires);

  const url = `http://localhost:3000/reset/${token}`;
  await transporter.sendMail({
    from: process.env.EMAIL_USER,
    to: email,
    subject: "Réinitialisation mot de passe",
    html: `Cliquez <a href="${url}">ici</a> pour réinitialiser votre mot de passe.`
  });

  res.render("reset-request", { message: "Email envoyé !" });
}
      </code></pre>

      <p>2. Réinitialisation du mot de passe (dans <code>authController.js</code>)</p>
      <pre><code>
import bcrypt from "bcrypt";
import { resetPassword, getUserByToken } from "../models/userModel.js";

export async function resetPasswordForm(req, res) {
  const { token } = req.params;
  const user = await getUserByToken(token);
  if (!user || user.reset_expires < Date.now()) {
    return res.render("reset-password", { error: "Lien invalide ou expiré." });
  }
  res.render("reset-password", { token });
}

export async function resetPasswordSubmit(req, res) {
  const { token } = req.params;
  const { password } = req.body;
  const user = await getUserByToken(token);
  if (!user || user.reset_expires < Date.now()) {
    return res.render("reset-password", { error: "Lien invalide ou expiré." });
  }
  const hashed = await bcrypt.hash(password, 10);
  await resetPassword(user.id, hashed);
  res.render("reset-password", { message: "Mot de passe réinitialisé avec succès !" });
}
      </code></pre>

      <p>3. Routes (<code>authRoutes.js</code>)</p>
      <pre><code>
router.get("/reset-request", (req, res) => res.render("reset-request"));
router.post("/reset-request", requestReset);

router.get("/reset/:token", resetPasswordForm);
router.post("/reset/:token", resetPasswordSubmit);
      </code></pre>

      <p>4. Templates Twig</p>
      <pre><code>
<!-- reset-request.twig -->
<form action="/reset-request" method="POST">
  <label>Email</label>
  <input type="email" name="email" required>
  <button type="submit">Envoyer</button>
  {% if message %}<p>{{ message }}</p>{% endif %}
  {% if error %}<p style="color:red">{{ error }}</p>{% endif %}
</form>

<!-- reset-password.twig -->
<form action="/reset/{{ token }}" method="POST">
  <label>Nouveau mot de passe</label>
  <input type="password" name="password" required>
  <button type="submit">Réinitialiser</button>
  {% if message %}<p>{{ message }}</p>{% endif %}
  {% if error %}<p style="color:red">{{ error }}</p>{% endif %}
</form>
      </code></pre>
    </section>

    <section class="next-step">
      <a href="09-gestion-roles.html" class="btn">Étape suivante : Gestion des rôles</a>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 Cours Annonces Sportives</p>
  </footer>

  <script src="js/app.js"></script>
</body>
</html>
