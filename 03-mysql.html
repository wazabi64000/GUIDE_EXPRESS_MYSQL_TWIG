<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Étape 3 — Connexion MySQL</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header>
    <h1>Étape 3 — Connexion MySQL</h1>
    <p>Créer la base de données, les tables et récupérer des données dans Express</p>
  <nav class="navbar">
  <a href="01-initialisation.html">Étape 1 — Initialisation du projet</a>
        <a href="02-twig.html">Étape 2 — Twig et premier rendu</a>
        <a href="03-mysql.html">Étape 3 — Connexion MySQL</a>
        <a href="04-mvc.html">Étape 4 — Structure MVC</a>
        <a href="05-auth-inscription.html">Étape 5 — Authentification (Inscription)</a>
        <a href="06-auth-connexion.html">Étape 6 — Authentification (Connexion)</a>
        <a href="07-verification-email.html">Étape 7 — Vérification d’email</a>
        <a href="08-reset-password.html">Étape 8 — Réinitialisation mot de passe</a>
        <a href="09-roles.html">Étape 9 — Gestion des rôles</a>
        <a href="10-crud-categories.html">Étape 10 — CRUD Catégories</a>
        <a href="11-crud-annonces.html">Étape 11 — CRUD Annonces + Upload images</a>
        <a href="12-securite-tests-deploiement.html">Étape 12 — Sécurité, tests et déploiement</a>
  </nav>
</header>

  <main>
    <section class="objectifs">
      <h2>Objectifs</h2>
      <ul>
        <li>Comprendre la logique d’une base de données relationnelle</li>
        <li>Créer une base MySQL et les tables nécessaires</li>
        <li>Connecter Node.js à MySQL via <code>mysql2</code></li>
        <li>Récupérer des données et les afficher via Twig</li>
      </ul>
    </section>

    <section class="explanation">
      <h2>Pourquoi MySQL ?</h2>
      <p>
        MySQL est une base de données relationnelle robuste et largement utilisée pour les applications web. 
        Elle permet de structurer les données (users, annonces, catégories, images) avec des relations claires.
      </p>
      <p>
        Exemple de relations :
      </p>
      <ul>
        <li>Un utilisateur peut créer plusieurs annonces</li>
        <li>Une annonce appartient à une catégorie</li>
        <li>Une annonce peut avoir plusieurs images</li>
      </ul>
    </section>

    <section class="commands">
      <h2>Création de la base et tables</h2>
      <pre><code>
-- Créer la base
CREATE DATABASE annonces_sportives;

-- Utiliser la base
USE annonces_sportives;

-- Table users
CREATE TABLE users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  nom VARCHAR(50),
  email VARCHAR(100) UNIQUE,
  password VARCHAR(255),
  role ENUM('user','organizer','admin') DEFAULT 'user',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Table categories
CREATE TABLE categories (
  id INT AUTO_INCREMENT PRIMARY KEY,
  nom VARCHAR(50),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Table annonces
CREATE TABLE annonces (
  id INT AUTO_INCREMENT PRIMARY KEY,
  titre VARCHAR(100),
  description TEXT,
  date_debut DATE,
  date_fin DATE,
  user_id INT,
  category_id INT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id),
  FOREIGN KEY (category_id) REFERENCES categories(id)
);

-- Table annonce_images
CREATE TABLE annonce_images (
  id INT AUTO_INCREMENT PRIMARY KEY,
  annonce_id INT,
  filename VARCHAR(255),
  FOREIGN KEY (annonce_id) REFERENCES annonces(id)
);
      </code></pre>

      <h3>Installation du package Node.js</h3>
      <pre><code>
npm install mysql2 dotenv
      </code></pre>
    </section>

    <section class="example">
      <h2>Connexion Node.js à MySQL</h2>
      <pre><code>
// src/config/db.js
import mysql from "mysql2/promise";
import dotenv from "dotenv";
dotenv.config();

const connection = await mysql.createConnection({
  host: process.env.DB_HOST || 'localhost',
  user: process.env.DB_USER || 'root',
  password: process.env.DB_PASSWORD || '',
  database: process.env.DB_NAME || 'annonces_sportives'
});

export default connection;

// src/server.js
import express from "express";
import connection from "./config/db.js";
import path from "path";
import { fileURLToPath } from "url";
import twig from "twig";

const app = express();
const PORT = 3000;

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

app.set("views", path.join(__dirname, "views"));
app.set("view engine", "twig");

app.get("/", async (req, res) => {
  const [annonces] = await connection.execute("SELECT * FROM annonces");
  res.render("index", { title: "Accueil Annonces Sportives", annonces });
});

app.listen(PORT, () => console.log(`Serveur démarré sur http://localhost:${PORT}`));
      </code></pre>

      <p>Cette configuration permet de récupérer les données MySQL et de les afficher dynamiquement via Twig.</p>
    </section>

    <section class="next-step">
      <a href="04-mvc.html" class="btn">Étape suivante : Structure MVC</a>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 Cours Annonces Sportives</p>
  </footer>

  <script src="js/app.js"></script>
</body>
</html>
